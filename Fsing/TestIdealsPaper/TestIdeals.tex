\documentclass{amsart}
\usepackage{calc,amssymb,amsthm,amsmath}
%\usepackage{mathtools}
\RequirePackage[dvipsnames,usenames]{xcolor}
\usepackage{hyperref}
\hypersetup{
bookmarks,
bookmarksdepth=3,
bookmarksopen,
bookmarksnumbered,
pdfstartview=FitH,
colorlinks,backref,hyperindex,
linkcolor=Sepia,
anchorcolor=BurntOrange,
citecolor=MidnightBlue,
citecolor=OliveGreen,
filecolor=BlueViolet,
menucolor=Yellow,
urlcolor=OliveGreen
}
\usepackage{xspace}
\usepackage{rotating}
\interfootnotelinepenalty=100000

\usepackage{mabliautoref}
\usepackage{colonequals}
\frenchspacing
\input{kmacros3.sty}
\usepackage{stmaryrd}

\usepackage{verbatim}
\usepackage{enumerate}

\usepackage[normalem]{ulem}
\usepackage{marginnote}

\DeclareMathOperator{\HH}{H}
\newcommand{\fram}{\mathfrak{m}}
%\DeclareMathOperator{\Image}{image}

\begin{document}
\title{The  {TestIdeals} package for \emph{Macaulay2}}
\author[Alberto F.\ Boix et at.]{Alberto F.\ Boix}
\address{Department of Mathematics, Ben-Gurion University of the Negev, Beer-Sheva 8410501, ISRAEL}
\email{fernanal@post.bgu.ac.il}
\thanks{A.F.B. is supported by Israel Science Foundation (grant No. 844/14) and Spanish Ministerio de Econom\'ia y Competitividad MTM2016-7881-P}
\author[]{Daniel J.\ Hern\'andez}
\address{Department of Mathematics, University of Kansas, Lawrence, KS~66045, USA}
\email{hernandez@ku.edu}
\author[]{Mordechai Katzman}
\author[]{Marcus Robinson}
\author[]{Karl Schwede}
\address{Department of Mathematics, University of Utah, Salt Lake City, UT~84112, USA}
\email{schwede@math.utah.edu}
\author[]{Daniel Smolkin}
\author[]{Pedro Teixeira}
\address{Department of Mathematics, Knox College, Galesburg, IL~61401, USA}
\email{pteixeir@knox.edu}
\author[]{Emily E.\ Witt}
\address{Department of Mathematics, University of Kansas, Lawrence, KS~66045, USA}
\email{witt@ku.edu}
\date{\today}

\begin{abstract}
	This note describes a \emph{Macaulay2} package for computations in prime characteristic commutative algebra.  This includes Frobenius powers and roots, $p^{-e}$-linear and $p^{e}$-linear  maps,
  singularities defined in terms of these maps, different types of test ideals and modules, and ideals compatible with a given $p^{-e}$-linear map.
\end{abstract}


\subjclass[2010]{13A35}%=

\keywords{Macaulay2}

\maketitle

\section{Introduction}

This paper describes methods for computing objects and numerical invariants in prime characteristic commutative algebra, implemented in the \texttt{TestIdeals.m2} package for the computer algebra system \emph{Macaulay2}.
A ring $R$ of prime characteristic $p>0$ comes equipped with the Frobenius endomorphism
\[ F: R \to R \ \text{ given by } F(x) =  x^p \]
which is the basis for many constructions and methods.
Notably, the Frobenius endomorphism can be used to detect whether a ring is regular \cite{KunzCharacterizationsOfRegularLocalRings}, and further, to quantify how far a ring is from being regular, measuring on the severity of a singularity.

In this direction, two notable applications of the Frobenius endomorphism are the theory of tight closure
(see \cite{HochsterHunekeTC1,HochsterFoundations} for an introduction)
and the resulting theory of test ideals
(see the survey \cite{SchwedeTuckerTestIdealSurvey}).  These methods are used by a wide group of commutative algebraists and algebraic geometers.
%That said, it remains a fundamental tool in the expanding area of prime characteristic commutative algebra.

The \texttt{TestIdeals.m2} package was started during a \emph{Macaulay2} development workshop in 2012, hosted by Wake Forest University (at the time, the package was called \texttt{PosChar.m2}).  The goal of this package was to provide a unified and efficient set of tools to study singularities in characteristic $p > 0$, and in particular, to collect and implement several algorithms that had been described in research papers.  Since then, the package \texttt{PosChar.m2} was split into two packages, \texttt{TestIdeals.m2} and \texttt{FThresholds.m2}, and
much more functionality has been added by many contributors, during several more \emph{Macaulay2} development workshops.\footnote{Development workshops hosted by the University of California, Berkeley (2014, 2017), Boise State University (2015), and the University of Utah (2016).}

%{\color{blue} [Maybe we don't need to list all examples?  Several other algorithms were implemented independently and incorporated into the package.]}
Starting at least with Kunz \cite{KunzCharacterizationsOfRegularLocalRings} and Fedder \cite{FedderFPureRat}, it has been known that the Frobenius endormorphism offers \emph{effective} methods for measuring singularities in characteristic $p > 0$.
However, the algorithms that form the basis of this package are the methods for computing Frobenius roots and $\star$-closures, and algorithms for computing parameter test ideals.
These first appeared in \cite{KatzmanParameterTestIdealOfCMRings,BlickleMustataSmithDiscretenessAndRationalityOfFThresholds,BlickleMustataSmithFThresholdsOfHypersurfaces,KatzmanFrobeniusMapsOnInjectiveHulls}.
Algorithms for computing $F$-pure thresholds from \cite{HernandezFInvariantsOfDiagonalHyp}, \cite{HernandezFPureThresholdOfBinomial}, and \cite{HernandezTeixeiraFThresholdFunctions} form some of the key methods in the forthcoming \texttt{FThresholds.m2} package.
Another algorithm in \cite{KatzmanSchwedeAlgorithm} for computing prime ideals compatible with a given $p^{-e}$-linear map was implemented and used to produce the examples in that paper.  The methods for computing test ideals and test modules that were used implicitly in papers such as \cite{BlickleSchwedeTakagiZhang,KatzmanLyubeznikZhangOnDiscretenessAndRationality,SchwedeTuckerTestIdealFiniteMaps} became implementable via the Frobenius roots functionality.
%{\hfill\large\color{red} [Expand: how were the test module methods conceived?]}\\




\subsection*{Acknowledgements}
The authors thank other contributors of the \texttt{TestIdeals.m2} package, which includes
Erin Bela, Juliette Bruce, Drew Ellingson, Zhibek Kadyrsizova, Sara Malec, Matthew Mastroeni, and Maral Mostafazadehfard.
This paper, and the finishing touches to the \texttt{TestIdeals.m2} package, were made at the University of Utah in 2018, and the visiting authors thank the Department of Mathematics for its hospitality.



\section{Frobenius powers and Frobenius roots}\label{Section: Frobenius powers and Frobenius roots}

Let $R$ denote a commutative ring of prime characteristic $p>0$.

\begin{definition}
Given an ideal $I\subseteq R$ and an integer $e\geq 0$, we define the \emph{$p^e$-th Frobenius power of $I$}, denoted $I^{[p^e]}$, to be the ideal
generated by the $p^e$-th powers of all elements of $I$.
\end{definition}

It is easy to see that if $I$ is generated by $g_1, \dots, g_\ell$, then $I^{[p^e]}$ is generated by $g_1^{p^e}, \dots, g_\ell^{p^e}$.


\begin{definition}
Given an ideal $I\subseteq R$ and an integer $e\geq 0$, we define the \emph{$p^e$-th Frobenius root of $I$}, denoted $I^{[1/p^{e}]}$, to be the smallest ideal $J$ such that $I\subseteq J^{[p^e]}$, if such an ideal exists.
\end{definition}

Frobenius roots always exist in polynomial and power series rings, and in $F$-finite regular rings
(cf.~\cite[\S 2]{BlickleMustataSmithDiscretenessAndRationalityOfFThresholds} and \cite[\S 5]{KatzmanParameterTestIdealOfCMRings}).
Below is an example where a Frobenius root is computed in a polynomial ring.
In Section~\ref{ss: math behind} we describe the main ideas behind such computations.

\medskip
\begin{verbatim}
i1 : R = ZZ/5[x,y,z];
i2 : I = ideal( x^6*y*z+x^2*y^12*z^3+x*y*z^18 );
o2 : Ideal of R
i3 : frobeniusPower( 1/5, I )
                2   3
o3 = ideal (x, y , z )
o3 : Ideal of R
\end{verbatim}
\medskip

\subsection{The mathematics behind the Frobenius roots algorithm}
\label{ss: math behind}

We can also describe Frobenius roots as follows:  In a (sufficiently local) regular ring, we have an identification of $R$ with its canonical module $\omega_R$.
On the other hand, the Grothendieck dual of the $e$-iterated Frobenius map\footnote{In a reduced ring $R$, it is often convenient to express the Frobenius endomorphism $R \to R$ as the inclusion $R \hookrightarrow R^{1/p}$, so that the source and target  are distinguished.} $R \to R^{1/p^e}$ provides a map
\begin{equation}
\label{eq.DualToFrobenius}
T : \omega_{R^{1/p^e}} \to \omega_R,
\end{equation}
which using the identification $R \cong \omega_R$ gives us a map
\[
T : R^{1/p^e} \to R.
\]
It is not difficult to prove that
$T(I^{1/p^e})=I^{[1/p^e]}$,
where $I^{1/p^e} \subseteq R^{1/p^e}$ is simply the ideal of $p^e$-th roots of the elements of $I$.
In the case that
\[
R = \bF_{p^e}[x_1, \ldots, x_d],
\]
$R^{1/p^e}$ is a free $R$-module with basis consisting of the elements
\[
\mathbf{x}^{\boldsymbol{\lambda}/p^e}= x_1^{\lambda_1/p^e} \cdots x_d^{\lambda_d/p^e}
\]
where $0 \leq \lambda_i \leq p^e-1$.
Furthermore, the map $T : R^{1/p^e} \to R$ is simply the projection defined as follows:
\[
T(x_1^{\lambda_1/p^e} \cdots x_d^{\lambda_d/p^e}) = \left\{ \begin{array}{rl} 1 &\text{if } \lambda_i = p^{e}-1 \text{ for all }i \\ 0 & \text{otherwise}  \end{array} \right.
\]
Using this, it is not difficult to see that if
\begin{equation}
\label{eqn1}
f^{1/p^e} = \sum_{\boldsymbol{\lambda}} \mathbf{x}^{\boldsymbol{\lambda} / p^e}
\end{equation}
where $\boldsymbol{\lambda}$ runs over the tuples $(\lambda_1, \dots, \lambda_d)$ with $0 \leq \lambda_j \leq p^e-1$, and $f_{\boldsymbol{\lambda}} \in R$, then
$(f)^{[1/p^e]} = T( (f)^{1/p^e})$ is the ideal generated by the $f_{\boldsymbol{\lambda}}$.
We can then compute $I^{[1/p^e]} = (f_1, \dots, f_m)^{[1/p^e]}$ for more general $I$ by linearity.

\subsubsection{Complexity}
The computation of Frobenius roots is the workhorse behind many of the methods in \texttt{TestIdeals.m2}.
Hence it is important to understand how this is implemented, and its computational complexity.

The computation of Frobenius roots of ideals reduces to the case of principal ideals, and its complexity grows linearly with the number of generators of the ideal.
Furthermore the calculation of  $(f)^{[1/p^e]}$ reduces to finding the summands in (\ref{eqn1}), which essentially amounts to
taking each term in $f$, computing the $p^e$-th root of the coefficient in $\mathbb{K}$, and dividing the monomial exponent vector by $p^e$ with remainder.
Hence the complexity of computing $(f)^{[1/p^e]}$ is proportional to the number of terms in $f$, and is independent of its degree.
\emph{The calculation of Frobenius roots does not involve the calculation of Gr\"obner bases.}

\subsection{Dual to Frobenius on quotient rings and Frobenius on top local cohomology}
\label{subsec.DualToFrobeniusOnQuotientRings}
For \emph{any} reduced ring $R$ with finite $e$-iterated Frobenius map identified with $R \hookrightarrow R^{1/p^e}$, we always have a map
\[
T_R : \omega_{R^{1/p^e}} \to \omega_R.
\]
At a maximal ideal $\fram$ of height $d$, this map is Matlis dual to the Frobenius map on $H^d_{\fram}(R)$.
Hence we can study local cohomology by studying this map.
If $R = S/I$, where $S$ is a polynomial ring over a finite field, then we can implement this map \cite{FedderFPureRat, KatzmanParameterTestIdealOfCMRings}.  We briefly explain the case of a hypersurface here.

If $I = (f)$, then again $\omega_R \cong R = S/I$, and the action of $T_R$ can be computed on $S$.  In fact, if $\overline{J} \subseteq R \cong \omega_R$ has preimage  $J \subseteq S$,
then setting $u = f^{p^e-1}$,
\[
T_R({\overline J}^{1/p^e}) = \overline{(u J)^{[1/p^e]}}.
\]
More generally, for non-hypersurfaces, the analog to $u$ is chosen carefully out of $I^{[p^e]} : I$  (see \cite{KatzmanParameterTestIdealOfCMRings} for details).
Here we compute two examples.

\medskip
\begin{verbatim}
i1 :  S = ZZ/5[x,y,z];
i2 :  f = x^3+y^3+z^3;
i3 :  u = f^(5-1);
i4 :  frobeniusRoot( 1, ideal u )
o4 =  ideal (z, y, x)
o4 :  Ideal of R

i5 :  S = ZZ/7[x,y,z];
i6 :  f = x^3+y^3+z^3;
i7 :  u = f^(7-1)
i8 :  frobeniusRoot( 1, ideal u )
o8 =  ideal 1
o8 :  Ideal of R
\end{verbatim}
\medskip

The above example has shown that the map on top local cohomology of the cone over the Fermat elliptic curve is injective in characteristic $7$ (the dual map $\omega_{R^{1/p}} \to \omega_R$ is surjective) and not injective in characteristic $5$ (the dual map $\omega_{R^{1/p}} \to \omega_R$ is not surjective).

\subsection{A generalization of Frobenius powers and roots}
We can extend the definition of Frobenius powers as follows:
\begin{definition}[cf. \cite{HernandezTeixeiraWittFrobeniusPowers}]
Let  $I\subseteq S$ be an ideal.
\begin{enumerate}
 \item[(a)] If $n$ is a positive integer with base $p$ expansion  $n=d_0 + d_1 p +  \dots + d_r p^r$, we define
\[ I^{[n]}=I^{d_0} (I^{d_1})^{[p]} \dots  (I^{d_r})^{[p^r]}.\]
 \item[(b)] If $t$ is a nonnegative rational number of the form $t = a/p^e$, we define  $I^{[t]} = {\big(I^{[a]}\big)}^{[1/p^e]}.$
 \item[(c)] If $t$ is any nonnegative rational number, and $\{a_n/p^{e_n}\}_{n\geq 1}$ is a sequence of rational numbers converging to $t$ from above, we define $I^{[t]}$
 to be the stable value of the non-decreasing chain of ideals $\{I^{[a_n/p^{e_n}]}\}_{n\geq 1}$.
\end{enumerate}
\end{definition}


\medskip
\begin{verbatim}
i1 : R = ZZ/7[x,y];
i2 : I = ideal( y^2-x^3 );
o2 : Ideal of R
i3 : frobeniusPower( 1/2, I )
o3 = ideal 1
o3 : Ideal of R
i4 : frobeniusPower( 5/6, I )
o4 = ideal (y, x)
o4 : Ideal of R
\end{verbatim}
\medskip


\subsection{Frobenius  roots of submodules of free modules}

Given a submodule $M$ of the free module $S^k$, there is a smallest submodule $N$ of $S^k$ that contains $M$, for which $M\subseteq N^{[p^e]}$.
Here,  $N^{[p^e]}$ is the submodule  of $S^k$ whose generators are the vectors of $N$ with all coordinates raised to the $p^e$-th power. (Cf.~\cite{KatzmanZhangAlgorithm}).

\begin{example}
Let $R=\ZZ/p\ZZ[a,b,c,d]$, and consider the ideals $\mathfrak{m}=(a,b,c,d)$ and
$$I= (a,b) \cap (a,c) \cap (c,d) \cap (c+d, a^3+b d^2)$$
of $R$; in fact, $R/I$ is a $3$-dimensional Cohen-Macaulay ring.
Matlis Duality applied to $H^2_{\mathfrak{m}} (R/I)$ with its natural Frobenius map
yields a $p^1$-linear map $U$ on $\Ext^2(R/ I, R)$.
%$\Ext^2(R/ I, R) \xrightarrow{U} \Ext^2(R/I, R)$.

\medskip
\begin{verbatim}
i2 :      p=2;
i3 :      R=ZZ/p[a,b,c,d];
i4 :      I=intersect( ideal(a,b), ideal(a,c), ideal(c,d), ideal(c+d, a^3+b*d^2));
i5 :      f=inducedMap (coker gens I, coker gens frobeniusPower(p,I) );
i6 :      resf=res f
          1             1
o6 = 0 : R  <--------- R  : 0
               | 1 |
          3                                      3
     1 : R  <---------------------------------- R  : 1
               {2} | ac+ad 0       0        |
               {3} | 0     bc2+bcd 0        |
               {4} | 0     0       a3d+bcd2 |
          2                                              2
     2 : R  <------------------------------------------ R  : 2
               {4} | abc2+abcd a2cd3+a2d4           |
               {5} | 0         a3cd+a3d2+bc2d2+bcd3 |
     3 : 0 <----- 0 : 3
              0
o6 : ChainComplexMap
i7 :      G=Hom(resf, R^1);
i8 :      E2=HH^2 G
o8 = {-8}  | a4+abc2+abcd a2b            |
     {-10} | a2cd3        a3cd+a3d2+bcd3 |
o8 : Matrix
i9 :      source E2
o9 = cokernel {-4} | bc  a  0   |
              {-5} | a2d d2 c+d |
                            2
o9 : R-module, quotient of R
i10 :       target E2
o10 = cokernel {-8}  | b2c2 a2 0     |
               {-10} | a4d2 d4 c2+d2 |
                             2
o10 : R-module, quotient of R
\end{verbatim}
\medskip

Frobenius on $H^2_{\mathfrak{m}} (R/I)$ is injective if and only if
$(\Image U)^{[1/p]}+\Image A=R^2$

\medskip
\begin{verbatim}
i11 :       U=matrix entries E2;
i12 :       A=matrix entries relations source E2;
i13 :       frobeniusRoot(1,U)
o13 = {-2} | 1 0 0 |
      {0}  | 0 d a |
              2       3
o13 : Matrix R  <--- R
\end{verbatim}
\medskip

so $R/I$ is not $F$-injective (cf. Section \ref{Section: F-singularities}).
This calculation also shows that $H^2_{\mathfrak{m}} (R/I)\cong \Ann_{E^2} A^t$
where $E$ is the injective hull of $R_{\mathfrak{m}}/ {\mathfrak{m}} R_{\mathfrak{m}}$,
and the Frobenius map on  $H^2_{\mathfrak{m}} (R/I)$ induced from Frobenius on $R$
is given by $U^t \Theta$ where $\Theta$ is the induced Frobenius on $E$.
The submodule of nilpotent elements in  $H^2_{\mathfrak{m}} (R/I)$ is
given by $\Ann_{E^2} B^t$ where $B$ is the smallest submodule of $R^2$ containing $\Image A + \Image U$ such that $U  B \subseteq B^{[p]}$.
The method \emph{ascendModule} can be used to calculate  $B$ (see detailed description of similar method \emph{ascendIdeal} in Section \ref{Section: Test Ideals}).

\medskip
\begin{verbatim}
i14 : V=ascendModule (1,A,U)
o14 = | 0   a  bc  |
      | c+d d2 a2d |
\end{verbatim}
\medskip


\end{example}


%\section{$p^{-e}$- and $p^{e}$-linear maps}\label{Section: p-linear maps}

%\begin{definition}%{\hfill\large\color{red} [Add references]}\\
%Let $M$ be an $S$-module and $e$ a nonnegative integer.
%\begin{enumerate}
% \item[(a)] A $p^{-e}$-linear map $\phi:M \rightarrow M$ is an additive map such that
% $\phi(s^{p^e} m)= s\phi(m)$ for all $s\in S$ and $m\in M$.
% \item[(b)] A $p^{e}$-linear map $\psi:M \rightarrow M$ is an additive map such that
% $\phi(s m)= s^{p^e}\phi(m)$ for all $s\in S$ and $m\in M$.
%\end{enumerate}
%\end{definition}


%The following two examples describe  prototypical
%$p^{-e}$- and $p^{e}$-linear maps.
%\begin{example}
%For any $S$-module $M$, we can construct a new $S$-module $M^{1/p^e}$ with elements $\{  m^{1/p^e} \,|\,m\in M\}$ by defining
%$m_1^{1/p^e} +  m_2^{1/p^e} =  (m_1 +  m_2)^{1/p^e}$ for all $m_1, m_2 \in M$ and
%$s  m^{1/p^e}=  (s^{p^e} m)^{1/p^e}$ for all $m\in M$ and $s\in S$.

%Consider any $\phi\in \Hom_S(M^{1/p^e}, M)$: if we identify $M^{1/p^e}$ with $M$ we can interpret $\phi$ as a $p^{-e}$-linear map.
%\end{example}

%\begin{example}
%The $e$-th Frobenius map $f:S \rightarrow S$  raising elements to their $p^e$-th power is clearly $p^{e}$-linear.
%Furthermore, for any ideal $I\subseteq S$ and $k\geq 0$, $f$ induces a $p^{e}$-linear map $H_I^k (S) \rightarrow H_I^k (S)$.
%\end{example}

%Let $R$ be a polynomial ring with irrelevant ideal $\mathfrak{m}$ and let $g$ be a nonzero element of $R$.
%Let $E=E_{R_{\mathfrak{m}}}(R_{\mathfrak{m}}/\mathfrak{m})$ denote the injective hull of $R_{\mathfrak{m}}/\mathfrak{m}$.

%The Frobenius map on $R$ induces a Frobenius map $S$ and on
%$H^{\dim R-1}_{\mathfrak{m}} (S)=E_S(S/\mathfrak{m}S)=\Ann_E g$ and the kernel of this map is given by
%$\Ann_E (g^{p-1}R)^{[1/p]}$ (cf.~\cite[\S 5]{KatzmanParameterTestIdealOfCMRings}).


%Thus we see that the induced $p^{e}$-linear map on $H_{(x,y,z)}^{2} \left( \mathbb{K}[x,y,z]/(x^3+y^3+z^3) \right)$ is injective
%when the characteristic of $\mathbb{K}$ is $7$ and non-injective when the characteristic is $5$.

%\subsection{Implementation and complexity}


%Let $R=\mathbb{K}[x_1, \dots, x_n]$ and fix $B$ to be $\mathbb{K}$-basis for $\mathbb{K}^{1/p^e}$.
%It is not hard to see that $R^{1/p^e}$ is a free $R$-module with free basis
%$$\left\{ b x_1^{\alpha_1/p^e} \dots x_n^{\alpha_n/p^e} \,|\, b \in B, 0\leq \alpha_1, \dots, \alpha_n < p^e \right\}.$$

%\begin{proposition}(cf. \cite[\S 5]{KatzmanParameterTestIdealOfCMRings})
%\begin{enumerate}
%\item[(a)] If the ideal $I\subseteq R$ is generated by $g_1, \dots, g_k\in R$, then $I^{[1/p^e]}=\sum_{i=1}^k (g_i R)^{[1/p^e]}$.
%\item[(b)] If
%\begin{equation}\label{eqn1}
%g=\sum_{b\in B, \atop{0\leq \alpha_1, \dots, \alpha_n < p^e}} r_{b, \alpha_1, \dots, \alpha_n} \left(b x_1^{\alpha_1/p^e} \dots x_n^{\alpha_n/p^e}\right),
%\end{equation}
%then $(gR)^{[1/p^e]}$ is generated by $\{ r_{b, \alpha_1, \dots, \alpha_n} \,|\, b\in B, 0\leq \alpha_1, \dots, \alpha_n < p^e \}$.
%\end{enumerate}
%\end{proposition}

\section{$F$-singularities}\label{Section: F-singularities}

This package includes methods for determining if a ring is $F$-injective, $F$-pure, $F$-rational or $F$-regular.

\subsection{$F$-injectivity}

\begin{definition}
A local ring $(R, \mathfrak{m})$ is called \emph{F-injective} if the map
$H^{i}_{\mathfrak{m}}(R) \rightarrow H^{i}_{\mathfrak{m}}(R^{1/p})$ is
injective for all $i >0$. An arbitrary ring is called \emph{$F$-injective} if its
localization at each prime ideal of $R$ is $F$-injective.
\end{definition}



\medskip
\begin{verbatim}
i2 : R = ZZ/7[x,y,z]/ideal(x^3 + y^3 + z^3);
i3 : isFinjective(R)
o3 = true
i4 : R = ZZ/5[x,y,z]/ideal(x^3 + y^3 + z^3);
i5 : isFinjective(R)
o5 = false
\end{verbatim}
\medskip

Equivalently, a ring is $F$-injective if the maps on the cohomology of the dualizing complex
\[
h^{-i} \omega_{R^{1/p}}^{\mydot} \to h^{-i} \omega_R^{\mydot}
\]
surject for all $i$.

The algorithm \texttt{isFinjective} determines whether the ring $R = S/I$ is
$F$-injective where $S$ is a polynomial ring.  Note that $h^{-i} \omega_R^{\mydot} \cong \Ext^{\dim S - i}(R, S)$, the latter of which Macaulay2 readily computes.
The algorithm works by checking the surjectivity of the dual Frobenius map
\[
\Ext^{\dim S - i}(R^{1/p}, S) \to \Ext^{\dim S - i}(R, S).
\]
%using the fact that the Matlist dual of \Ext^{i}(\blank, S)$ \cong H^{\dim S -
%i}_{\mathfrak{m}}(\blank) $.
We begin by computing the map $R
\rightarrow R^{1/p}$ using the \texttt{PushForward.m2} package \cite{PushForward}.
Next the algorithm computes
$\Ext^{i}( \blank, S)$ applied to the map from the previous step.  Then $R$ is $F$-injective precisely when the
cokernel of $\Ext^{i}( \blank, S)$ is trivial for $i$.

The Frobenius action on top local cohomology (dual to $\omega_R$) is usually computed in a different (faster) way than the other cohomologies, and this is modified by the \texttt{CanonicalStrategy} option.  The default option is \texttt{CanonicalStrategy => Katzman} which instead of using the \texttt{PushForward.m2} package, relies on the fact that we already know how to compute the Frobenius action on the canonical module, as described in \autoref{subsec.DualToFrobeniusOnQuotientRings}.


%The \texttt{CanonicalStrategy} tag can be used to modify the strategy the
%algorithm uses to check the Frobenius action on the top local cohomology.
%By default the algorithm is set to \texttt{CanonicalStrategy => Katzman} which
%then uses the strategy of Katzman {\hfill\large\color{red} [Add
%references]}. If the tag is set to anything else \texttt{CanonicalStrategy =>
%null} the algorithm checks the top local cohomology using the same brute
%force strategy used to check the injectivity at lower degrees. The Katzman
%strategy is typically much faster.

The performance of the algorithm can be improved if the ring of interest is
nice enough. If the ring is Cohen-Macaulay then, setting \texttt{AssumeCM =>
true} (the default is \texttt{false}) lets the algorithm check the Frobenius action only on top cohomology
(which is typically much faster as explained above).
%The default value for the option \texttt{AssumeCM} is \texttt{false}.
%Of
%course, telling the algorithm to assume the ring is Cohen-Macaulay when it
%is not can lead to an incorrect answer if the non-injective Frobenius
%occurs in a lower degree. For an example of this see the documentation.
When studying a reduced ring,  setting \texttt{AssumedReduced => true} (the default option) avoids
computing the bottom local cohomology, and when studying a normal ring, setting
\texttt{AssumeNormal => true} (the default is \texttt{false}) avoids computing the bottom two local
cohomologies.

By default the algorithm checks for $F$-injectivity at all points of $\Spec R$.  However one
can choose to check $F$-injectivity only at the origin by setting the
option \texttt{IsLocal => true}.

\medskip
\begin{verbatim}
i2 : R = ZZ/7[x,y,z]/ideal( (x-1)^5 + (y+1)^5 + z^5 );
i3 : isFinjective(R)
o3 = false
i4 : isFinjective(R, IsLocal=>true)
o4 = true
\end{verbatim}
\medskip

\subsection{$F$-regularity}

\begin{definition}[\cite{HochsterHunekeTC1,HaraWatanabeFRegFPure}]
A ring $R$ is called \emph{strongly $F$-regular} if the (big) test ideal $\tau(R) = R$.  Likewise a pair $(R, f^t)$ is called \emph{strongly $F$-regular} if $\tau(R, f^t) = R$.
\end{definition}


The command \texttt{isFregular} checks whether a ring or pair is strongly
$F$-regular. Below are two examples one $F$-regular and one not.


\medskip
\begin{verbatim}
i2 : R = ZZ/5[x,y,z]/ideal(x^2 + y*z);
i3 : isFregular(R)
o3 = true
i4 : R = ZZ/7[x,y,z]/ideal(x^3 + y^3 + z^3);
i5 : isFregular(R)
o5 = false
\end{verbatim}
\medskip

We can also check whether a pair $(R, f^t)$ is $F$-regular.

\medskip
\begin{verbatim}
i2 : R = ZZ/5[x,y];
i3 : f = y^2-x^3;
i4 : isFregular(1/2, f)
o4 = true
i5 : isFregular(5/6, f)
o5 = false
i6 : isFregular(4/5, f)
o6 = false
i7 : isFregular(4/5-1/100000, f)
o7 = true
\end{verbatim}
\medskip

All of these checks are done by actually computing the test ideal (as described in \autoref{Section: Test Ideals}).

If the input ring is $\mathbb{Q}$-Gorenstein then in each of the cases above the output is a boolean indicating if the
ring is strongly $F$-regular. If the input ring is not
$\mathbb{Q}$-Gorenstein then the algorithm can be used to determine if a
ring is strongly $F$-regular but cannot prove a ring is not strongly
$F$-regular (you can enable this latter functionality by setting \texttt{QGorensteinIndex => infinity}).


In the case that $R$ is $\mathbb{Q}$-Gorenstein, the algorithm works by
computing the test ideal $\tau$ of the ring  (or the pair) using \texttt{testIdeal}
and checking whether $\tau=R$.
In the non-$\mathbb{Q}$-Gorenstein case the algorithm checks for
strong $F$-regularity by computing better and
better approximations of the test ideal, and checking whether any of these is the unit ideal.
To compute approximations of the
test ideal the algorithm computes a test element $c$ with \texttt{testElement}
and then uses \texttt{frobeniusRoot} to compute the $e$-th root of
$c(I^{[p^{e}]} : I)$ (appropriate modifications are made for pairs). If at
any step the approximation is the unit ideal then then the algorithm
returns \texttt{true}. Otherwise the algorithm continues checking for each $e$
until a specified limit is reached. The default limit is 2 and can be
changed using the option \texttt{DepthOfSearch}.


A number of options can be used to speed up the performance of some of the
internal functions. The option \texttt{AssumeDomain} can be used if $R$ is an
integral domain, \texttt{FrobeniusRootStrategy} chooses a strategy for
internal \texttt{frobeniusRoot} calls, \texttt{MaxCartierIndex => ZZ} sets the
maximum Gorenstein index to search for when working with a
$\mathbb{Q}$-Gorenstein ambient ring and \texttt{QGorensteinIndex => ZZ}
allows the user to specify the $\mathbb{Q}$-Gorenstein index of the ring.


The default behavior of \texttt{isFregular} is that it checks for strong $F$-regularity
globally. If the option \texttt{IsLocal => true}, the algorithm will only
check at the origin by checking whether the computed test ideal is in the irrelevant ideal.
Below is an example for both a ring and a pair.


\medskip
\begin{verbatim}
i2 : R = ZZ/7[x,y,z]/ideal((x-1)^3+(y+1)^3+z^3);
i3 : isFregular(R)
o3 = false
i4 : isFregular(R, IsLocal=>true)
o4 = true
i5 : R = ZZ/13[x,y];
i6 : f = (y-2)^2 - (x-3)^3;
i7 : isFregular(5/6, f)
o7 = false
i8 : isFregular(5/6, f, IsLocal=>true)
o8 = true
\end{verbatim}
\medskip

\subsection{$F$-purity}
\begin{definition}
A ring $R$ is called \emph{$F$-pure} if
\sout{the inclusion $R \subset R^{1/p^{e}}$ split.}
the inclusion $R \subset R^{1/p^{e}}$ is a pure map, i.e.,
the tensor of this map with any $R$-module remain injective.
\end{definition}

Macaulay2 can compute if a ring is $F$-pure using \texttt{isFpure}. Either a
ring or a defining ideal can be input as seen in this example.


\medskip
\begin{verbatim}
i2 : R = ZZ/5[x,y,z]/ideal(x^2+y*z);
i3 : isFpure(R)
o3 = true
i4 : R = ZZ/7[x,y,z]/ideal(x^3+y^3+z^3);
i5 : isFpure(R)
o5 = true
i6 : S = ZZ/2[x,y,z];
i6 : isFpure(ideal(y^2-x^3))
o6 = false
i7 : isFpure(ideal(z^2-x*y*z+x*y^2+x^2*y))
o7 = true
\end{verbatim}
\medskip


The algorithm works by applying Fedder's Criterion {\cite{FedderFPureRat}}, which states that a
local ring $(R, \mathfrak{m})$ is $F$-pure if and only if $(I^{[p]} : I)
\not\subseteq \mathfrak{m}^{[p]}$. In the local case the tag \texttt{IsLocal
=> true} checks $F$-purity at the origin by explicitly checking the above
containment. In the non-local case, which is the default option, the
algorithm computes the non $F$-pure locus by applying \texttt{frobeniusRoot}
to $I^{[p]} :I$. If the non $F$-pure locus is the whole ring the algorithm
returns \texttt{true}.

\subsection{$F$-rationality}

\begin{definition}
Suppose that $R$ is a Cohen-Macaulay ring and that $T_{R} :
\omega_{R^{1/p}} \rightarrow \omega_{R}$ is the canonical dual of
Frobenius. We say that $R$ has \emph{$F$-rational singularities} if there
are no non-zero proper submodules $M$ of $\omega_{R}$ such that
$T_{R}(M^{1/p}) \subseteq M$.
\end{definition}


\medskip
\begin{verbatim}
i2 : S = ZZ/3[a,b,c,d,t];
i3 : m = 4;
i4 : n = 3;
i5 : M = matrix{ {a^2 + t^m, b, d}, {c, a^2, b^n-d} };
i6 : I = minors(2, M);
i7 : R = S/I;
i8 : isFrational(R)
o8 = true
\end{verbatim}
\medskip


The command \texttt{isFrational} checks if a ring is $F$-rational. First the
algorithm checks if the ring is Cohen-Macaulay.
This check can be skipped by setting \texttt{isCohenMacaulay => true}. If the ring
is not Cohen-Macaulay then \texttt{false} is returned. Next the algorithm
computes the test module $M \subseteq \omega_{R}$ and checks to see if
$\omega_{R} \subseteq M$.  See the next section for the description of a test module.


The option tags \texttt{AssumeDomain} and \texttt{FrobeniusRootStrategy} can be
used to improved the speed of the \texttt{testModule} computation. By default
these tags are set to \texttt{false} and \texttt{Substitution} respectively. The
\texttt{IsLocal => true} tag can be used to check for $F$-rationality only at
the origin.


\section{Test ideals}\label{Section: Test Ideals}

In this section, we explain how to compute parameter test modules, parameter test ideals, test ideals and HSLG-modules\footnote{HSLG-modules can be used to give a scheme structure to the $F$-injective or $F$-pure locus.}.

\subsection{Parameter test modules}

Given an $F$-finite reduced ring $R$, the Frobenius map $R \to R^{1/p^e}$ is dual to $T : \omega_{R^{1/p^e}} \to \omega_R$.  As before in \autoref{subsec.DualToFrobeniusOnQuotientRings}, we can represent the canonical module $\omega_R \subseteq R$ as an ideal, we can write $R = S/I$, and so we can find a $u \in S^{1/p^e}$ representing the map $\omega_{R^{1/p^e}} \to \omega_R$, see \autoref{subsec.DualToFrobeniusOnQuotientRings} or \cite{KatzmanParameterTestIdealOfCMRings}.

The parameter test submodule is the smallest submodule $M \subseteq \omega_R$ (and hence ideal of $R$ since $M \subseteq \omega_R \subseteq R$) that agrees generically with $\omega_R$ and that satisfies
\[
T (M^{1/p^e}) \subseteq M.
\]
Using \emph{Macaulay2}, we can compute this using the \texttt{testModule} command as follows.

\medskip
\begin{verbatim}
i3 : R = ZZ/5[x,y,z]/ideal(x^4+y^4+z^4);
i4 : N = testModule(R);
i5 : N#0
             2             2        2
o5 = ideal (z , y*z, x*z, y , x*y, x )
o5 : Ideal of R
i6 : N#1
o6 = ideal 1
o6 : Ideal of R
\end{verbatim}
\medskip

The output of \texttt{testModule} is a list, consisting of three items:
\begin{enumerate}
\item The first entry is the test module.
\item The second is the canonical module (as an ideal) that it lives inside.
\item The third is the element $u$ described above (not displayed here, since it can take a lot of space).
\end{enumerate}
Note since this ring is Gorenstein, the canonical module is simply represented as the unit ideal.

Here is another example where the ring is not Gorenstein.

\medskip
\begin{verbatim}
i2 : R = ZZ/5[x,y,z]/ideal(y*z, x*z, x*y);
i3 : N = testModule(R);
i4 : N#0
             2   2   2
o4 = ideal (z , y , x )
o4 : Ideal of R
i5 : N#1
o5 = ideal (y - z, x + z)
o5 : Ideal of R
\end{verbatim}
\medskip

We briefly explain how this is computed:  First we find a \emph{test element}.
\begin{remark}[Computation of test elements]
\label{rem.ComputationOfTestElements}
Roughly, we recall that an element of the Jacobian ideal that is not contained in any minimal prime is a test element \cite{HochsterFoundations}.  We compute test elements by computing random partial derivatives (and linear combinations thereof) until we find an element that does not vanish at all the minimal primes.  This method is much faster than computing the entire Jacobian ideal.  If you know your ring is a domain, you can use the \texttt{AssumeDomain} flag to speed this up further.
\end{remark}

After the test element $c$ has been identified, we pullback the ideal $\omega_R$ to an ideal $J = S$.  Then we compute the following ascending sequence of ideals
\begin{equation}
\label{eq.AscendIdealExplanation}
\begin{array}{rll}
J_1 := &  J + (c J)^{[1/p]} & = {\tt J + frobeniusRoot(1, c*J)}\\
J_2 := & J + (c J)^{[1/p]} + (c^{1+p} J)^{[1/p^2]} & = {\tt J_1 + frobeniusRoot(1, c*J_1)}\\
J_3 := & J + (c J)^{[1/p]} + (c^{1+p} J)^{[1/p^2]} + (c^{1+p+p^2} J)^{[1/p^3]} & = {\tt J_2 + frobeniusRoot(1, c*J_2)}.\\
\dots
\end{array}
\end{equation}
As soon as this ascending sequence of ideals stabilizes, we are done.
In fact, because this strategy is used in several contexts, you can call it directly for a chosen ideal $J$ and $u$ with the function \texttt{ascendIdeal} (this is done for test ideals below).

We can also compute parameter test modules of pairs $\tau(\omega_R, f^{t})$ with $t \in \mathbb{Q}_{\geq 0}$.  This is done by modifying the element $u$ when the denominator of $t$ is not divisible by $p$.  When $t$ has $p$ in the denominator, we rely on the fact (see \cite{BlickleMustataSmithDiscretenessAndRationalityOfFThresholds,SchwedeTuckerTestIdealFiniteMaps}) that
\[
\begin{array}{rcl}
T(\tau(\omega_R, f^a)) & = & \tau(\omega_R, f^{a/p})\\
{\tt frobeniusRoot(1, u*I_1)} & {\tt =} & {\tt I_2}
\end{array}
\]
Where the second line roughly explains how this is accomplished internally, here ${\tt I_1}$ is $\tau(\omega_R, f^a)$ pulled back to $S$ and likewise $I_2$ defines $\tau(\omega_R, f^a)$ modulo the defining ideal of $R$.

\begin{remark}[Optimizations in \texttt{ascendIdeal} and other \texttt{testModule} computations]
Throughout the computations described above, we very frequently use the following fact:
\[
(f^p \cdot J)^{[1/p]} = f \cdot (J^{[1/p]}).
\]
To access this enhancement, one should try to pass functions like \texttt{ascendIdeal} and \texttt{frobeniusRoot} the elements and their exponents (see the documentation).  In particular, do not multiply out expressions like $f^n \cdot J$ if you will be applying \texttt{frobeniusRoot}.
\end{remark}

\subsection{Parameter test ideals}

The parameter test ideal is simply the annihilator of $\omega_R/\tau(\omega_R)$.  In other words, it is
\[
\tau(\omega_R) : \omega_R.
\]
This can also be described as
\[
\bigcap_{I} (I^* : I)
\]
where $I$ varies over ideals defined by a partial system of parameters and $I^*$ denotes its tight closure.  This latter description is not computable however.

\begin{example}\label{Example: parameter test ideal}
In this example we repeat the calculation in \cite[\S 9]{KatzmanParameterTestIdealOfCMRings}.

\medskip
{
\begin{verbatim}
i2 : R=ZZ/2[x_1..x_5];
i3 : E=matrix {{x_1,x_2,x_2,x_5},{x_4,x_4,x_3,x_1}};
             2       4
o3 : Matrix R  <--- R
i4 : I=minors(2,E);
o4 : Ideal of R
i5 : J=parameterTestIdeal(R/I)
o5 = ideal (x  + x , x , x )
             3    4   2   1
                                                    R
o5 : Ideal of ----------------------------------------------------------------------------
                                                       2
              (x x  + x x , x x  + x x , x x  + x x , x  + x x , x x  + x x , x x  + x x )
                1 4    2 4   1 3    2 4   2 3    2 4   1    4 5   1 2    4 5   1 2    3 5
i6 :      J=substitute(J,R);
o6 : Ideal of R
i7 : mingens(J+I)
o7 = | x_3+x_4 x_2 x_1 x_4x_5 |
             1       4
o7 : Matrix R  <--- R
\end{verbatim}
\medskip
}
\end{example}

\subsection{Test ideals}

For an $F$-finite reduced ring $R = S/I$ where $S$ is a regular ring, the (big) test ideal
\footnote{The notion of test ideals was originally introduced in \cite{HochsterHunekeTC1} in the context of tight closure in finitely generated modules, whereas our notion of test ideals arises from
tight closure in possibly non-generated (``big'') modules. Confusingly, big test ideals are included in (small) test ideals.}
of $R$ is the smallest ideal $J$ in $R$, not contained in any minimal prime, such that for all $e > 0$ and all
\[
\phi \in \Hom_R(R^{1/p^e}, R) \text{ we have } \phi(J^{1/p^e}) \subseteq J.
\]
In the case that $R$ is Gorenstein,
%\sout{there is a map $\Phi_e \in \Hom_R(R^{1/p^e}, R)$ which generates the $\Hom$-set as an $R^{1/p^e}$-module.  }
$\Hom_R(R^{1/p^e}, R)$ is a cyclic $R^{1/p^e}$-module generated by
$\Phi_e$ which corresponds with the map $T$ above based on the identification
$\omega_R \cong R$, \cite{BlickleSchwedeSurveyPMinusE}.  More generally, if $R$ is $\bQ$-Gorenstein with index not divisible by $p$, then for at least sufficiently divisible $e > 0$, such a generating $\Phi_e$ still exists.

If such a $\Phi_e$ exists, it can be identified as the generator of the module $(I^{[p^e]} : I) / I^{[p^e]}$ by Fedder's Lemma, \cite{FedderFPureRat}.  Hence we can find a corresponding\footnote{This is done via the function \texttt{QGorensteinGenerator}. } $u \in I^{[p^e]} : I$.  In this case, if $c \in S$ is the pre-image of a test element of $R$, then setting $I_0 = cR$, it follows that
\[
\tau(R) = {\tt ascendIdeal(e, u, I_0)}.
\]
Recall that \texttt{ascendIdeal} is explained above in \autoref{eq.AscendIdealExplanation}.  The $e$ here means all frobenius roots are taken as multiples of $e$.

Here is an example (a $\bZ/3\bZ$-quotient where $3 | (7-1)$), where exactly this logic occurs.

\medskip
\begin{verbatim}
i3 : T = ZZ/7[x,y];
i4 : S = ZZ/7[a,b,c,d];
i5 : f = map(T, S, {x^3, x^2*y, x*y^2, y^3});
i6 : I = ker f;
i7 : R= S/I;
i8 : testIdeal(R)
o8 = ideal 1
o8 : Ideal of R
\end{verbatim}
\medskip

However, the term $u$ constructed above can be quite complicated if $e > 1$ (which happens exactly when $(p -1)K_R$ is not Cartier).  For instance, even in the above example:

\medskip
\begin{verbatim}
i9 : toString(QGorensteinGenerator(1, R))
o9 = a^2*b^6*c^12+a^3*b^4*c^13+a^3*b^5*c^11*d+a^4*b^3*c^12*d+a^5*b*c^13*d+b^12
      *c^6*d^2+a^3*b^6*c^9*d^2+a^4*b^4*c^10*d^2+a^5*b^2*c^11*d^2+a^6*c^12*d^2+b
      ^13*c^4*d^3+a*b^11*c^5*d^3+a^2*b^9*c^6*d^3+a^4*b^5*c^8*d^3+a^5*b^3*c^9*d^
      3+a^6*b*c^10*d^3+a*b^12*c^3*d^4+a^2*b^10*c^4*d^4+a^3*b^8*c^5*d^4+a^4*b^6*
      c^6*d^4+a^5*b^4*c^7*d^4+a^6*b^2*c^8*d^4+a^7*c^9*d^4+a*b^13*c*d^5+a^2*b^11
      *c^2*d^5+a^3*b^9*c^3*d^5+a^4*b^7*c^4*d^5+a^5*b^5*c^5*d^5+a^6*b^3*c^6*d^5+
      a^7*b*c^7*d^5+a^2*b^12*d^6+a^3*b^10*c*d^6+a^4*b^8*c^2*d^6+a^5*b^6*c^3*d^6
      +a^6*b^4*c^4*d^6+a^7*b^2*c^5*d^6+a^8*c^6*d^6+a^4*b^9*d^7+a^5*b^7*c*d^7+a^
      6*b^5*c^2*d^7+a^7*b^3*c^3*d^7+a^8*b*c^4*d^7+a^6*b^6*d^8+a^7*b^4*c*d^8+a^8
      *b^2*c^2*d^8+a^9*c^3*d^8+a^8*b^3*d^9+a^9*b*c*d^9+a^10*d^10
\end{verbatim}
\medskip

Therefore, we use a different strategy if either $(p-1)K_R$ is not Cartier or more generally if $R$ is $\bQ$-Gorenstein of index divisible by $p$.   In these situations, this alternate strategy typically appears to be faster.  We rely on the following observation, see \cite{BlickleSchwedeTuckerTestAlterations}.
\[
\tau(\omega_R, K_R) \cong \tau(R).
\]
In fact, by embedding $\omega_R \subseteq R$, we can compute $g$ so that $\tau(\omega_R, K_R) = g \tau(R)$.  We can therefore find $\tau(R)$ if we can find $\tau(\omega_R, K_R)$.
Next, if $K_R$ is $\bQ$-Cartier with $nK_R = \Div_R(f)$ for some $f \in R$ and $n > 0$, then
\[
\tau(\omega_R, K_R) =\tau(\omega_R, f^{1/n}).
\]
Thus we directly compute $\tau(\omega_R, f^{1/n})$ via the command \texttt{testModule(1/n, f)}.  Consider the following example, a $\mu_3$-quotient.

\medskip
\begin{verbatim}
i2 : T = ZZ/3[x,y];
i3 : S = ZZ/3[a,b,c,d];
i4 : f = map(T, S, {x^3, x^2*y, x*y^2, y^3});
i5 : I = ker f;
i6 : R = S/I;
i7 : testIdeal(R)
o7 = ideal 1
o7 : Ideal of R
\end{verbatim}
\medskip

Which uses the logic described above.

\begin{remark}[Non-graded caveats]
It frequently can happen that $(I^{[p^e]} : I)/I^{[p^e]}$ is principal but Macaulay2 cannot identify the principal generator (since Macaulay2 cannot always find minimal generators of non-graded ideals or modules).  The same thing can happen when computing the $u$ corresponding to the map $T : \omega_{R^{1/p}} \to \omega_R$, as described in \autoref{subsec.DualToFrobeniusOnQuotientRings} above.  In such situations, instead of a single $u$, we Macaulay2 will produce $u_1, \dots, u_n$ (all multiples of $u$, and $u$ is a linear combination of the $u_i$).  Instead of computing things like
\[
(u \cdot J)^{[1/p]},
\]
we will instead compute
\[
(u_1 \cdot J)^{[1/p]} + \dots + (u_n \cdot J)^{[1/p]}
\]
which will produce the same answer.
\end{remark}

We can similarly use the \texttt{testIdeal} command to compute test ideals of pairs $\tau(R, f^t)$, and even more general mixed test ideals $\tau(R, f_1^{t_1} \cdots f_n^{t_n})$.

\subsection{HSLG module, computing $F$-pure submodules of rank-1 Cartier modules}

Again consider the maps $T^e : \omega_{R^{1/p^e}} \to \omega_R$ we have considered throughout this section.  It is a theorem of Hartshorne-Speiser, Lyubeznik, and Gabber \cite{HartshorneSpeiserLocalCohomologyInCharacteristicP,LyubeznikFModulesApplicationsToLocalCohomology,Gabber.tStruc} that the descending images
\[
\omega_R \supseteq T(\omega_{R^{1/p}}) \supseteq \dots \supseteq T^e(\omega_{R^{1/p^e}}) \supseteq T_{e+1}(\omega_{R^{1/p^{e+1}}}) \supseteq \dots
\]
stabilize for $e \gg 0$.  The function \texttt{HSLGModule} computes this.

\medskip
\begin{verbatim}
i4 : R = ZZ/3[x,y,z]/ideal(x^3+y^4+z^5);
i5 : L = HSLGModule(R);
i6 : L#0
                          2        2   3
o6 = ideal (0, y*z, x*z, y , x*y, x , z )
o6 : Ideal of R
i7 : L#1
o7 = ideal 1
o7 : Ideal of R
i8 : L#3
o8 = 1
\end{verbatim}
\medskip

The function returns a list.  The first entry is the submodule.  The second is the canonical module.  The third entry is the $u$ representing the map on the canonical module (see \autoref{subsec.DualToFrobeniusOnQuotientRings} above)
%\marginnote{Fix the autoref (look at the LaTeX source)}
and the final entry is at what value of $e > 0$ the image stabilizes.

%\bigskip\sout{In a Gorenstein ring, this submodule coincides philosophically with the maximal non-LC ideal of Fujino-Schwede-Takagi.}
%\marginnote{Can someone explain this without recourse to philosophy or morality?}


More generally for any ideal $J$ with a map $\phi : J^{1/p^e} \to J$, we have that the images
\[
J \supseteq \phi(J^{1/p^e}) \supseteq \phi^2(J^{1/p^{2e}}) \supseteq \dots
\]
stabilize as well (in fact, the analogous result even holds for modules).


\section{Ideals compatible with given $p^{-e}$-linear map}\label{Section: compatible ideals}

Throughout this section let $R$ denote a polynomial $\mathbb{K}[x_1, \dots, x_n]$. In this section we address the following question:
given a $R$-linear map $\phi: R^{1/p^e} \rightarrow R$, what are all ideals $I\subseteq R$ such that $\phi(I^{1/p^e})=I$?
We call these ideals $\phi$-compatible.

Recall that  $\Hom_R( R^{1/p^e}, R)$  is a principal $R^{1/p^e}$-module generated
the \emph{trace map} $T\in \Hom_R(R^{1/p^e}, R)$, constructed as follows (cf. \cite[Lemma 1.6]{FedderFPureRat} and \cite[Example 1.3.1]{BrionKumarFrobeniusSplitting}).
Recall that, if $B$ is a $\mathbb{K}$-basis for $\mathbb{K}^{1/p^e}$ (with $1\in B$),
$R^{1/p^e}$ is a free $R$-module with basis
$$\left\{ b x_1^{\alpha_1/p^e} \dots x_n^{\alpha_n/p^e} \,|\, 0\leq \alpha_1, \dots, \alpha_n < p^e \right\} ;$$
the trace map $T$ is the projection onto the free summand
$R x_1^{(p^e-1)/p^e} \dots x_n^{(p^e-1)/p^e}\cong R$.

We can now write our given $\phi$ as multiplication by some $u^{1/p^e}$ followed by $T$ and it is not hard to see that
an ideal $I\subseteq R$ is $\phi$-compatible if and only if $u I \subseteq I^{[p^e]}$.

\begin{theorem}\label{Theorem: finitely many compatible primes}
If $\phi$ is surjective, there are finitely many $\phi$-compatible ideals, consisting of all possible intersections
of $\phi$-compatible prime ideals (cf. \cite{KumarMehtaFiniteness}, \cite{SchwedeFAdjunction},
\cite{SharpGradedAnnihilatorsOfModulesOverTheFrobeniusSkewPolynomialRing}, \cite{EnescuHochsterTheFrobeniusStructureOfLocalCohomology}).

In general, there are finitely many $\phi$-compatible prime ideals not containing $\sqrt{\Image \phi}$ (cf. \cite{KatzmanSchwedeAlgorithm}).

\end{theorem}

The method \emph{compatibleIdeals} produces the finite set of $\phi$-compatible prime ideals in the second statement of Theorem \ref{Theorem: finitely many compatible primes}.

\medskip
\begin{verbatim}
i2 :      R = ZZ/3[u,v];
i3 :      u = u^2*v^2;
i4 :      compatibleIdeals(u)
o4 = {ideal v, ideal (v, u), ideal u}
o4 : List
\end{verbatim}
\medskip

The defining condition $u I = I^{[p]}$ for $\phi$-compatible ideals allows us to
think of these in a dual form: write $\mathfrak{m}=(x_1, \dots, x_n)R$,
$E=E_{R_\mathfrak{m}}(R_{\mathfrak{m}}/\mathfrak{m})=H^n_{\mathfrak{m}} (R)$, and let
$\Theta: E \rightarrow E$ be the $p^e$-linear map\footnote{I.e., $\Theta$ is additivive and $\Theta (r a)= r^{p^e} \Theta (a)$ for all $a\in E$ and $r\in R$.}
induced from the Frobenius map on $R$.
If $\psi=u \Theta$, then $\psi \Ann_E I \subseteq \Ann_E I$ if and only if $u I = I^{[p]}$!
Thus finding all $R$-submodules of $E$ compatible with $\psi=u \Theta$ also amounts to finding all
$\phi=T \circ u^{1/p^e}$-compatible ideals.

\begin{example}

We return to Example \ref{Example: parameter test ideal}.
In (cf.~\cite[\S 9]{KatzmanParameterTestIdealOfCMRings}) it is shown that
there is a surjection $\Ann_E I \rightarrow H^2_{\mathfrak{m}} (R/I)$
which is compatible with with the induced $p^1$-linear map on $H^2_{\mathfrak{m}} (R/I)$
and the $p^1$-linear map $u \Theta$ on $\Ann_E I$ where $u$ is computed as follows.

\medskip
\begin{verbatim}
i2 :      R=ZZ/2[x_1..x_5];
i3 :      E=matrix {{x_1,x_2,x_2,x_5},{x_4,x_4,x_3,x_1}};
             2       4
o3 : Matrix R  <--- R
i4 :      I=minors(2,E);
o4 : Ideal of R
i5 :      isCohenMacaulay(R/I)
o5 = true
\end{verbatim}
\medskip

In \cite{KatzmanParameterTestIdealOfCMRings} it is shown that as that $R/I$ is Cohen-Macaulay $u$
can be taken as the generator of the cyclic module $(I^{[p]}:I) \cap (\Omega^{[p]}:\Omega)/I^{[p]}$
where $\Omega \subseteq R$ is an ideal whose image in $I$ is a canonical module of $R/I$.


\medskip
\begin{verbatim}
i6 :           omega=canonicalIdeal(R/I)
o6 = ideal (x , x , x )
             5   4   1
                                                    R
o6 : Ideal of ----------------------------------------------------------------------------
                                                       2
              (x x  + x x , x x  + x x , x x  + x x , x  + x x , x x  + x x , x x  + x x )
                1 4    2 4   1 3    2 4   2 3    2 4   1    4 5   1 2    4 5   1 2    3 5
i7 :      omega=substitute(omega,R)+I;
o7 : Ideal of R
i8 :      u=intersect((frobeniusPower(2,I)):I,(frobeniusPower(2,omega)):omega);
o8 : Ideal of R
i9 :      u=compress((gens u)%(gens(frobeniusPower(2,I))))
o9 = | x_1^3x_2x_3+x_1^3x_2x_4+x_1^2x_3x_4x_5+x_1x_2x_3x_4x_5+x_1x_2x_4^2x_5+
     x_2^2x_4^2x_5+x_3x_4^2x_5^2+x_4^3x_5^2 |
             1       1
o9 : Matrix R  <--- R
i10 :       u=first first entries  u
       3        3        2                           2      2 2        2 2    3 2
o10 = x x x  + x x x  + x x x x  + x x x x x  + x x x x  + x x x  + x x x  + x x
       1 2 3    1 2 4    1 3 4 5    1 2 3 4 5    1 2 4 5    2 4 5    3 4 5    4 5
o10 : R
\end{verbatim}
\medskip

Now we can compute all annihilators of $R$-submodules of $E$ stable under the $p^1$-linear map $uT$

\medskip
\begin{verbatim}
i12 :       L=compatibleIdeals(u)
              3        3        2                           2      2 2
o12 = {ideal(x x x  + x x x  + x x x x  + x x x x x  + x x x x  + x x x  +
              1 2 3    1 2 4    1 3 4 5    1 2 3 4 5    1 2 4 5    2 4 5
      --------------------------------------------------------------------------
         2 2    3 2                    2
      x x x  + x x ), ideal (x  + x , x  + x x ), ideal (x , x ), ideal (x , x ,
       3 4 5    4 5           1    2   1    4 5           4   1           4   1
      --------------------------------------------------------------------------

      x ), ideal (x , x , x , x ), ideal (x , x , x , x , x ), ideal (x , x ,
       5           5   4   1   3           5   4   3   2   1           5   4
      --------------------------------------------------------------------------

      x , x ), ideal (x , x , x ), ideal (x , x , x , x ), ideal (x , x , x ),
       2   1           4   1   3           4   3   2   1           4   2   1
      --------------------------------------------------------------------------
                                2
      ideal (x  + x , x  + x , x  + x x ), ideal (x  + x , x , x , x ), ideal
              3    4   1    2   2    4 5           3    4   2   1   5
      --------------------------------------------------------------------------
      (x , x , x )}
        2   1   5
o12 : List
\end{verbatim}
\medskip

and all annihilators of $R$-submodules of $H^2_{\mathfrak{m}} (R/I)$ stable under the $p^1$-linear map induced from the Frobenius map on $R/I$.

\medskip
\begin{verbatim}
i14 :       unique apply(L, J-> (J:omega))
              3        3        2                           2      2 2
o14 = {ideal(x x x  + x x x  + x x x x  + x x x x x  + x x x x  + x x x  +
              1 2 3    1 2 4    1 3 4 5    1 2 3 4 5    1 2 4 5    2 4 5
      --------------------------------------------------------------------------
         2 2    3 2                    2
      x x x  + x x ), ideal (x  + x , x  + x x ), ideal (x , x ), ideal (x , x ,
       3 4 5    4 5           1    2   2    4 5           4   1           5   4
      --------------------------------------------------------------------------

      x ), ideal 1, ideal (x , x , x ), ideal (x , x , x , x ), ideal (x , x ,
       1                    4   3   1           4   3   2   1           4   2
      --------------------------------------------------------------------------
                                     2
      x ), ideal (x  + x , x  + x , x  + x x ), ideal (x , x  + x , x , x ),
       1           3    4   1    2   2    4 5           5   3    4   2   1
      --------------------------------------------------------------------------
      ideal (x , x , x )}
              5   2   1
o14 : List
\end{verbatim}
\medskip

\end{example}

\section{Future plans}

In \cite{KatzmanZhangAlgorithm} the algorithms behind the method in Section \ref{Section: compatible ideals} were extended
to compute prime annihilators of submodules of Artinian modules compatible with a given $p^{e}$-linear map.
This would require, among other things, a faster implementation of our method for finding Frobenius roots of submodules of free modules.

On the other hand, it should be possible to compute test ideals of pairs $(R, \fra^t)$ even when $\fra$ is not principal.  One strategy to do this is outlined in \cite{SchwedeTuckerTestIdealsOfNonPrincipal} although certain improvement can be made.

We hope to achieve all these things during a future \emph{Macaulay2} workshop.  We also want to bring to the reader's attention the package \texttt{FThresholds.m2} which computes $F$-pure thresholds, $F$-thresholds, $F$-jumping numbers and more!

\bibliographystyle{skalpha}
\bibliography{MainBib}



\end{document}
